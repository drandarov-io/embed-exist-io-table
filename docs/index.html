<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <title>Embeddable exist.io table</title>
  <link rel="stylesheet" href="./style.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>

<script>
  const params = new URLSearchParams(document.location.search);
  const key = params.get("key");
  
  console.info(key);

  var scriptName = "embed.js"; //name of this script, used to get reference to own tag
  var jQuery; //noconflict reference to jquery
  var jqueryPath = "https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"; 
  var jqueryVersion = "1.8.3";
  var scriptTag; //reference to the html script tag

  /******** Get reference to self (scriptTag) *********/
  var allScripts = document.getElementsByTagName('script');
  var targetScripts = [];
  for (var i in allScripts) {
    var name = allScripts[i].src
    if(name && name.indexOf(scriptName) > 0)
      targetScripts.push(allScripts[i]);
  }

  scriptTag = targetScripts[targetScripts.length - 1];

  /******** helper function to load external scripts *********/
  function loadScript(src, onLoad) {
    var script_tag = document.createElement('script');
    script_tag.setAttribute("type", "text/javascript");
    script_tag.setAttribute("src", src);

    if (script_tag.readyState) {
      script_tag.onreadystatechange = function () {
        if (this.readyState === 'complete' || this.readyState === 'loaded') {
          onLoad();
        }
      };
    } else {
      script_tag.onload = onLoad;
    }
    (document.getElementsByTagName("head")[0] || document.documentElement).appendChild(script_tag);
  }

  /******** helper function to load external css  *********/
  function loadCss(href) {
    var link_tag = document.createElement('link');
    link_tag.setAttribute("type", "text/css");
    link_tag.setAttribute("rel", "stylesheet");
    link_tag.setAttribute("href", href);
    (document.getElementsByTagName("head")[0] || document.documentElement).appendChild(link_tag);
  }

  /******** load jquery into 'jQuery' variable then call main ********/
  if (window.jQuery === undefined || window.jQuery.fn.jquery !== jqueryVersion) {
    loadScript(jqueryPath, initjQuery);
  } else {
    initjQuery();
  }

  function initjQuery() {
    jQuery = window.jQuery.noConflict(true);
    main();
  }
  
  function add_custom_tag_table(custom_tag, name) {    
    const url = "https://exist.io/api/1/users/$self/attributes/" + custom_tag + "/"
    const proxy = "https://cors-anywhere.herokuapp.com/"          
    element = document.getElementById("widget_content")
    
    $.ajax({
          dataType: "json",
          beforeSend: function(request) {
              request.setRequestHeader("Authorization", "Bearer " + key);
          },
          url: proxy + url,
          //data: data,
          success: function(result) {
            table = document.createElement("table")
            element.appendChild(table)
            var row = document.createElement("tr")
            table.appendChild(row)
            var row_2 = document.createElement("tr")
            table.appendChild(row_2)
            var p = document.createElement("p")
            p.innerHTML = name
            element.appendChild(p)
            
            results = result["results"].reverse()
            
            for (var i = 0; i < results.length; i++){
              
              var obj = results[i];
              
              var value_block = document.createElement('td');
              var date_block = document.createElement('td');
              
              var date_split = obj["date"].split("-")
              var date = new Date(date_split[0], date_split[1], date_split[2])
              date_block.innerHTML = date.getMonth() + "-" + date.getDate();
              
              if (obj["value"] === 1) {
                value_block.innerHTML = "ðŸ”¥";
              
              } else {
                value_block.innerHTML = "âš¬";
              }
              row.appendChild(value_block)
              row_2.appendChild(date_block)
            }
          }
      });
  }
  
  function add_mood_table() {    
    const url = "https://exist.io/api/1/users/$self/attributes/mood/"
    const proxy = "https://cors-anywhere.herokuapp.com/"          
    element = document.getElementById("widget_content")
    
    $.ajax({
          dataType: "json",
          beforeSend: function(request) {
              request.setRequestHeader("Authorization", "Bearer " + key);
          },
          url: proxy + url,
          //data: data,
          success: function(result) {
            table = document.createElement("table")
            element.appendChild(table)
            var row = document.createElement("tr")
            table.appendChild(row)
            var row_2 = document.createElement("tr")
            table.appendChild(row_2)
            var p = document.createElement("p")
            p.innerHTML = "Mood"
            element.appendChild(p)
            
            results = result["results"].reverse()
            
            for (var i = 0; i < results.length; i++){
              
              var obj = results[i];
              
              var value_block = document.createElement('td');
              var date_block = document.createElement('td');
              
              var date_split = obj["date"].split("-")
              var date = new Date(date_split[0], date_split[1], date_split[2])
              date_block.innerHTML = date.getMonth() + "-" + date.getDate();
              
              value_block.innerHTML = obj["value"]
              if (obj["value"] === 5) {
                value_block.setAttribute('class', 'five');
              } else if (obj["value"] === 4) {
                value_block.setAttribute('class', 'four');
              } else if (obj["value"] === 3) {
                value_block.setAttribute('class', 'three');
              } else if (obj["value"] === 2) {
                value_block.setAttribute('class', 'two');
              } else if (obj["value"] === 1) {
                value_block.setAttribute('class', 'one');
              }
              
              row.appendChild(value_block)
              row_2.appendChild(date_block)
            }
          }
      });
  }

  /******** starting point for your widget ********/
  function main() {
    //your widget code goes here
      
    jQuery(document).ready(function ($) {
      //or you could wait until the page is ready
      
      add_mood_table()
      add_custom_tag_table("sport_strength_training", "Sport")
      add_custom_tag_table("health_intermittent_fasting", "Fasting")
      add_custom_tag_table("thinking_brain_exercise", "Brain Exc.")

      //example load css
      //loadCss("http://example.com/widget.css");

      //example script load
      //loadScript("http://example.com/anotherscript.js", function() { /* loaded */ });
    });

  }
</script>

<div id="widget_content">

</div>
<!-- partial -->
  
</body>
</html>
